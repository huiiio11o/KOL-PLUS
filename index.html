<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KOL Manager Plus - Earth Tone Edition</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        earth: {
                            sable: '#d6cec6',
                            keestone: '#f1e4d1',    // 淺色主背景
                            adobebuff: '#e5d2ba',   // 淺色卡片
                            cobblestone: '#b59e87',
                            camel: '#e1aa69',
                            creambeige: '#dcc6b0',
                            platinumgray: '#a59489',
                            autumntan: '#a7623d',   // 強調褐
                            coralbeige: '#bd9a83',
                            charcoal: '#4a3731',    // 深色主背景
                            terracotta: '#b55c3e',  // 主按鈕色
                            rosewood: '#925345'     // 深色卡片
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .font-kol { font-family: 'Dancing Script', cursive; }
        .font-main { font-family: 'Noto Sans TC', sans-serif; }
        .glass {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass {
            background: rgba(74, 55, 49, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fab-press:active { transform: scale(0.9); }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="font-main transition-colors duration-500 min-h-screen select-none" 
      :class="isDark ? 'bg-earth-charcoal text-earth-keestone' : 'bg-earth-keestone text-earth-charcoal'" id="app">

    <!-- 頂部 Header -->
    <header class="p-6 pb-2">
        <h1 class="font-kol text-6xl tracking-[0.5em] w-full text-center py-6 overflow-hidden whitespace-nowrap" 
            :class="isDark ? 'text-earth-camel' : 'text-earth-autumntan'">
            KOL
        </h1>
        
        <div class="flex justify-between items-center px-1 mt-2">
            <div>
                <span class="text-[10px] uppercase font-bold opacity-60">數據統計</span>
                <p class="text-2xl font-black">{{ kolList.length }} <span class="text-sm font-normal">位</span></p>
            </div>
            
            <button @click="toggleDarkMode" class="flex items-center gap-2 p-3 rounded-2xl glass shadow-sm active:scale-90 transition-all">
                <i :data-lucide="isDark ? 'sun' : 'moon'" class="w-5 h-5"></i>
                <span class="text-xs font-bold">{{ isDark ? '太陽：淺色' : '月亮：深色' }}</span>
            </button>
        </div>
    </header>

    <main class="px-5 pt-4 pb-32">
        <!-- 篩選器 -->
        <section class="mb-6">
            <div class="flex items-center gap-2 mb-3 px-1">
                <i data-lucide="tag" class="w-4 h-4 opacity-60"></i>
                <span class="text-xs font-bold uppercase tracking-widest">分類標籤篩選</span>
            </div>
            <div class="flex flex-wrap gap-2">
                <div v-for="tag in allTags" :key="tag" class="relative group">
                    <button @click="toggleFilterTag(tag)"
                        :class="selectedFilters.includes(tag) ? 'bg-earth-terracotta text-white shadow-lg scale-105' : 'bg-earth-adobebuff/50 dark:bg-earth-rosewood/50'"
                        class="pl-3 pr-8 py-2 rounded-xl text-xs font-medium transition-all flex items-center">
                        #{{ tag }}
                    </button>
                    <!-- 刪除標籤按鈕 -->
                    <button @click.stop="deleteGlobalTag(tag)" class="absolute right-1 top-1/2 -translate-y-1/2 p-1 text-earth-terracotta opacity-40 hover:opacity-100">
                        <i data-lucide="x-circle" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- 網紅列表 -->
        <div class="space-y-4">
            <div v-for="kol in filteredList" :key="kol.id" 
                 class="glass rounded-[32px] p-5 relative overflow-hidden transition-all border-l-[10px] active:scale-[0.98]"
                 :style="{ borderLeftColor: getTierColor(kol.tier) }">
                
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 flex-wrap">
                            <h3 class="font-bold text-xl">{{ kol.name }}</h3>
                            <span class="text-[10px] px-2 py-0.5 rounded-full font-bold bg-white/20" :style="{ color: getTierColor(kol.tier) }">{{ kol.tier }}</span>
                        </div>
                        <p class="text-[10px] opacity-40 mt-1 flex items-center gap-1">
                            <i data-lucide="calendar" class="w-3 h-3"></i> {{ kol.createdAt }}
                        </p>
                    </div>
                    <div class="flex gap-1">
                        <button @click="editKOL(kol)" class="p-2 text-earth-camel"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                        <button @click="deleteKOL(kol.id)" class="p-2 text-earth-terracotta"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                </div>

                <!-- 平台 Icon 展示 -->
                <div class="flex flex-wrap gap-4 mt-5">
                    <div v-for="(link, platform) in kol.platforms" :key="platform" v-show="link" 
                         class="bg-white/30 dark:bg-black/20 p-2 rounded-2xl">
                        <a :href="link" target="_blank" class="block hover:scale-110 transition">
                            <img :src="getIcon(platform)" class="w-6 h-6 rounded-md object-cover shadow-sm">
                        </a>
                    </div>
                </div>

                <!-- 標籤展示 -->
                <div class="mt-4 flex flex-wrap gap-1.5">
                    <span v-for="tag in kol.tags" :key="tag" class="text-[10px] border border-earth-autumntan/30 text-earth-autumntan px-2 py-0.5 rounded-md">#{{ tag }}</span>
                </div>
                
                <div v-if="kol.note" class="mt-4 p-3 rounded-2xl bg-earth-adobebuff/30 dark:bg-earth-rosewood/30 text-xs italic opacity-70 leading-relaxed border-t border-white/5">
                    {{ kol.note }}
                </div>
            </div>
        </div>

        <div v-if="filteredList.length === 0" class="py-20 text-center opacity-30 italic text-sm">
            目前沒有符合篩選條件的網紅
        </div>
    </main>

    <!-- 漂浮新增按鈕 (FAB) -->
    <button @click="openAddModal" 
            class="fixed bottom-24 right-6 w-16 h-16 bg-earth-terracotta text-white rounded-full shadow-[0_10px_30px_rgba(181,92,62,0.4)] flex items-center justify-center z-50 fab-press hover:rotate-90 transition-all duration-300">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>

    <!-- 底部導覽列 -->
    <nav class="fixed bottom-0 left-0 right-0 glass h-20 flex justify-around items-center px-10 rounded-t-[40px] z-[45] border-t border-white/20">
        <button @click="activeTab = 'list'" class="flex flex-col items-center gap-1" :class="activeTab === 'list' ? 'text-earth-terracotta' : 'opacity-40'">
            <i data-lucide="layout-grid" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">名單列表</span>
        </button>
        <button @click="openSyncModal" class="flex flex-col items-center gap-1" :class="activeTab === 'sync' ? 'text-earth-terracotta' : 'opacity-40'">
            <i data-lucide="cloud-upload" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">同步試算表</span>
        </button>
    </nav>

    <!-- 新增/編輯 抽屜彈窗 -->
    <div v-if="showModal" class="fixed inset-0 z-[100] flex items-end justify-center bg-earth-charcoal/80 backdrop-blur-sm transition-opacity">
        <div class="w-full max-w-md bg-earth-keestone dark:bg-earth-charcoal rounded-t-[40px] p-8 max-h-[92vh] overflow-y-auto no-scrollbar shadow-2xl slide-up">
            <div class="w-12 h-1.5 bg-earth-platinumgray/30 rounded-full mx-auto mb-8" @click="showModal = false"></div>
            
            <h2 class="text-2xl font-black mb-8 text-center tracking-widest text-earth-autumntan">{{ isEditing ? '編輯資料' : '新增網紅名單' }}</h2>
            
            <div class="space-y-6">
                <!-- 1. 主平台連結與自動帶入 -->
                <div class="space-y-2">
                    <label class="text-xs font-bold opacity-60 px-1">主要平台連結 (輸入後將自動解析帳號與連結)</label>
                    <input v-model="form.primaryLink" @input="handleAutoParse" placeholder="貼上 IG / FB / YT 連結..." 
                           class="w-full p-4 rounded-2xl dark:bg-earth-rosewood bg-white border-none outline-none text-sm ring-1 ring-earth-adobebuff">
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold opacity-60 px-1">網紅名稱 (自動解析帳號)</label>
                    <input v-model="form.name" placeholder="例如：maillard_girl" class="w-full p-4 rounded-2xl dark:bg-earth-rosewood bg-white border-none outline-none ring-1 ring-earth-adobebuff">
                </div>
                
                <div class="space-y-2">
                    <label class="text-xs font-bold opacity-60 px-1">等級分類</label>
                    <select v-model="form.tier" class="w-full p-4 rounded-2xl dark:bg-earth-rosewood bg-white border-none outline-none text-sm appearance-none ring-1 ring-earth-adobebuff">
                        <option value="寶寶網紅">寶寶網紅 (1k-10k)</option>
                        <option value="網紅">網紅 (10k-30k)</option>
                        <option value="鑽石級網紅">鑽石級網紅 (30k-50k)</option>
                        <option value="大網紅(50000以上)">大網紅(50,000以上)</option>
                    </select>
                </div>

                <!-- 2. 整合平台連結 (自動帶入後可編輯) -->
                <div class="space-y-3">
                    <label class="text-xs font-bold opacity-60 px-1">整合平台連結庫</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div v-for="(val, key) in form.platforms" :key="key" class="flex items-center gap-2 bg-white dark:bg-earth-rosewood p-3 rounded-2xl ring-1 ring-earth-adobebuff">
                            <img :src="getIcon(key)" class="w-5 h-5 rounded-md grayscale opacity-50">
                            <input v-model="form.platforms[key]" :placeholder="key.toUpperCase()" class="bg-transparent text-[10px] outline-none w-full">
                        </div>
                    </div>
                </div>

                <!-- 3. 標籤管理 -->
                <div class="space-y-3">
                    <label class="text-xs font-bold opacity-60 px-1">分類標籤 (多選/新增)</label>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="tag in allTags" :key="tag" 
                            @click="toggleFormTag(tag)"
                            :class="form.tags.includes(tag) ? 'bg-earth-autumntan text-white shadow-md' : 'bg-earth-creambeige dark:bg-white/10'"
                            class="px-4 py-2 rounded-xl text-xs font-medium transition-all">
                            {{ tag }}
                        </button>
                        <div class="flex gap-1 items-center bg-earth-terracotta/10 rounded-xl px-3 border border-dashed border-earth-terracotta">
                            <input v-model="newTagName" placeholder="新分類" class="text-xs py-2 w-16 bg-transparent outline-none">
                            <button @click="addNewTag" class="text-earth-terracotta font-bold">+</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold opacity-60 px-1">備註欄位</label>
                    <textarea v-model="form.note" placeholder="記錄合作內容或風格備註..." class="w-full p-4 rounded-2xl dark:bg-earth-rosewood bg-white border-none outline-none h-24 text-sm ring-1 ring-earth-adobebuff"></textarea>
                </div>

                <div class="flex gap-4 pt-6 pb-10">
                    <button @click="showModal = false" class="flex-1 p-5 rounded-[24px] bg-earth-creambeige dark:bg-white/10 font-bold uppercase tracking-widest text-xs">取消</button>
                    <button @click="saveKOL" class="flex-1 p-5 rounded-[24px] bg-earth-terracotta text-white font-bold shadow-lg active:scale-95 transition-all uppercase tracking-widest text-xs">儲存名單</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 同步試算表彈窗 -->
    <div v-if="showSyncModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-earth-charcoal/90 backdrop-blur-md p-6">
        <div class="w-full max-w-sm glass rounded-[40px] p-8 slide-up">
            <h2 class="text-xl font-black mb-2 text-center text-earth-camel">同步至試算表</h2>
            <p class="text-[10px] mb-8 opacity-60 text-center tracking-[0.3em] uppercase">Select Active User</p>
            
            <div class="flex flex-col gap-3">
                <button v-for="u in ['媽咪', 'Winnie', '蟬說']" :key="u" 
                    @click="syncUser = u"
                    :class="syncUser === u ? 'border-2 border-earth-terracotta bg-earth-terracotta text-white' : 'bg-white/10 text-white'"
                    class="p-5 rounded-2xl text-center font-bold transition-all active:scale-95">
                    {{ u }}
                </button>
            </div>
            <div class="flex gap-4 mt-10">
                <button @click="showSyncModal = false" class="flex-1 p-4 rounded-2xl bg-white/10 text-white text-xs">取消</button>
                <button @click="submitToGoogleSheet" :disabled="!syncUser || isSyncing" class="flex-1 p-4 rounded-2xl bg-earth-camel text-earth-charcoal font-bold disabled:opacity-20 text-xs transition-all">
                    {{ isSyncing ? '同步中...' : '確認上傳' }}
                </button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const isDark = ref(false);
                const showModal = ref(false);
                const showSyncModal = ref(false);
                const isEditing = ref(false);
                const activeTab = ref('list');
                const isSyncing = ref(false);

                // 核心數據
                const kolList = ref(JSON.parse(localStorage.getItem('kol_data_final') || '[]'));
                const allTags = ref(JSON.parse(localStorage.getItem('kol_tags_final') || '["美妝", "育兒", "美食", "旅遊", "部落客"]'));
                const selectedFilters = ref([]);
                
                const form = ref({
                    id: null,
                    name: '',
                    primaryLink: '',
                    tier: '寶寶網紅',
                    tags: [],
                    platforms: { ig: '', fb: '', xhs: '', yt: '', tiktok: '', blog: '' },
                    note: '',
                    createdAt: ''
                });

                const newTagName = ref('');
                const syncUser = ref('');

                // 顏色與圖標
                const getTierColor = (tier) => {
                    const colors = { 
                        '寶寶網紅': '#bd9a83', 
                        '網紅': '#a7623d', 
                        '鑽石級網紅': '#b55c3e',
                        '大網紅(50000以上)': '#4a3731'
                    };
                    return colors[tier] || '#ccc';
                };

                const getIcon = (p) => {
                    const icons = {
                        ig: 'https://cdn-icons-png.flaticon.com/512/174/174855.png',
                        fb: 'https://cdn-icons-png.flaticon.com/512/733/733547.png',
                        xhs: 'https://is1-ssl.mzstatic.com/image/thumb/Purple126/v4/3d/8d/68/3d8d6892-2580-c081-9b1a-853f6068257d/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-10.png/512x512bb.jpg',
                        yt: 'https://cdn-icons-png.flaticon.com/512/1384/1384060.png',
                        tiktok: 'https://cdn-icons-png.flaticon.com/512/3046/3046121.png',
                        blog: 'https://cdn-icons-png.flaticon.com/512/60/60736.png'
                    };
                    return icons[p];
                };

                const toggleDarkMode = () => {
                    isDark.value = !isDark.value;
                    document.documentElement.classList.toggle('dark');
                    setTimeout(() => lucide.createIcons(), 10);
                };

                // 自動清理功能：刪除 7 天前的資料
                const autoCleanup = () => {
                    const sevenDaysInMs = 7 * 24 * 60 * 60 * 1000; // 七天的毫秒數
                    const now = Date.now();
                    const initialLength = kolList.value.length;

                    // 過濾掉超過七天的資料 (利用 id 作為時間戳記判斷)
                    kolList.value = kolList.value.filter(kol => {
                        return (now - kol.id) < sevenDaysInMs;
                    });

                    if (kolList.value.length < initialLength) {
                        console.log(`自動清理：已移除 ${initialLength - kolList.value.length} 筆超過 7 天的舊資料。`);
                        saveToLocal(); // 儲存變更
                    }
                };

                const openAddModal = () => {
                    isEditing.value = false;
                    form.value = { id: Date.now(), name: '', primaryLink: '', tier: '寶寶網紅', tags: [], platforms: { ig: '', fb: '', xhs: '', yt: '', tiktok: '', blog: '' }, note: '', createdAt: '' };
                    showModal.value = true;
                    setTimeout(() => lucide.createIcons(), 50);
                };

                const handleAutoParse = () => {
                    const url = form.value.primaryLink.trim();
                    if (!url) return;
                    let handle = '';
                    if (url.includes('instagram.com/')) {
                        handle = url.split('instagram.com/')[1].split('/')[0].split('?')[0];
                        form.value.platforms.ig = url;
                    } else if (url.includes('facebook.com/')) {
                        handle = url.split('facebook.com/')[1].split('/')[0].split('?')[0];
                        form.value.platforms.fb = url;
                    } else if (url.includes('youtube.com/')) {
                        handle = url.split('@')[1] ? url.split('@')[1].split('/')[0] : 'Youtube頻道';
                        form.value.platforms.yt = url;
                    } else if (url.includes('tiktok.com/@')) {
                        handle = url.split('@')[1].split('/')[0];
                        form.value.platforms.tiktok = url;
                    }
                    if (handle) form.value.name = handle;
                };

                const saveKOL = () => {
                    if (!form.value.name) return alert('請填寫網紅名稱/帳號');
                    const dupIdx = kolList.value.findIndex(k => k.name === form.value.name && k.id !== form.value.id);
                    if (dupIdx !== -1) {
                        if (confirm(`重複警報：已有名單「${form.value.name}」，是否刪除舊筆並儲存新筆？`)) {
                            kolList.value.splice(dupIdx, 1);
                        } else { return; }
                    }
                    if (!isEditing.value) {
                        const now = new Date();
                        form.value.createdAt = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
                        kolList.value.unshift({ ...form.value });
                    } else {
                        const idx = kolList.value.findIndex(k => k.id === form.value.id);
                        kolList.value[idx] = { ...form.value };
                    }
                    saveToLocal();
                    showModal.value = false;
                    setTimeout(() => lucide.createIcons(), 10);
                };

                const deleteKOL = (id) => {
                    if (confirm('確定要刪除這位網紅嗎？')) {
                        kolList.value = kolList.value.filter(k => k.id !== id);
                        saveToLocal();
                    }
                };

                const editKOL = (kol) => {
                    isEditing.value = true;
                    form.value = JSON.parse(JSON.stringify(kol));
                    showModal.value = true;
                    setTimeout(() => lucide.createIcons(), 50);
                };

                const deleteGlobalTag = (tag) => {
                    if(confirm(`確定要永久刪除「${tag}」標籤嗎？這會從篩選庫中移除。`)) {
                        allTags.value = allTags.value.filter(t => t !== tag);
                        selectedFilters.value = selectedFilters.value.filter(t => t !== tag);
                        saveToLocal();
                    }
                };

                const toggleFilterTag = (tag) => {
                    if (selectedFilters.value.includes(tag)) {
                        selectedFilters.value = selectedFilters.value.filter(t => t !== tag);
                    } else {
                        selectedFilters.value.push(tag);
                    }
                };

                const toggleFormTag = (tag) => {
                    if (form.value.tags.includes(tag)) {
                        form.value.tags = form.value.tags.filter(t => t !== tag);
                    } else {
                        form.value.tags.push(tag);
                    }
                };

                const addNewTag = () => {
                    const t = newTagName.value.trim();
                    if (t && !allTags.value.includes(t)) {
                        allTags.value.push(t);
                        form.value.tags.push(t);
                        newTagName.value = '';
                        saveToLocal();
                    }
                };

                const saveToLocal = () => {
                    localStorage.setItem('kol_data_final', JSON.stringify(kolList.value));
                    localStorage.setItem('kol_tags_final', JSON.stringify(allTags.value));
                };

                const filteredList = computed(() => {
                    if (selectedFilters.value.length === 0) return kolList.value;
                    return kolList.value.filter(k => selectedFilters.value.every(f => k.tags.includes(f)));
                });

                const openSyncModal = () => {
                    activeTab.value = 'sync';
                    showSyncModal.value = true;
                    setTimeout(() => lucide.createIcons(), 50);
                };

                const submitToGoogleSheet = async () => {
                    if (kolList.value.length === 0) return alert('清單為空，無法同步');
                    isSyncing.value = true;
                    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzAFMdwbeGbh7FO-3HH638NSrDg8SXlTpnNIgKTdvmUM8MPN3g3ipqHLuPTXjCBTpg/exec'; 
                    try {
                        await fetch(SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user: syncUser.value, data: kolList.value })
                        });
                        alert(`【${syncUser.value}】同步成功！數據已推送到雲端。`);
                        showSyncModal.value = false;
                        activeTab.value = 'list';
                    } catch (e) {
                        alert('同步失敗，請確認網路或 GAS 權限設置。');
                    } finally {
                        isSyncing.value = false;
                    }
                };

                onMounted(() => {
                    autoCleanup(); // 啟動時自動檢查並清理七天前資料
                    lucide.createIcons();
                });

                return {
                    isDark, showModal, showSyncModal, isEditing, activeTab, isSyncing,
                    kolList, allTags, selectedFilters, form, newTagName, syncUser,
                    filteredList, toggleDarkMode, openAddModal, handleAutoParse, 
                    saveKOL, deleteKOL, editKOL, toggleFilterTag, toggleFormTag, deleteGlobalTag,
                    addNewTag, getTierColor, getIcon, openSyncModal, submitToGoogleSheet
                };
            }
        }).mount('#app');
    </script>
</body>
</html>